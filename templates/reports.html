{% extends "base.html" %}

{% block title %} Reports -
  {% if date_start and date_end %}
    From {{ date_start }} to {{ date_end }}
  {% elif date_start %}
    Everything from {{ date_start }}
  {% elif date_end %}
    Everything until {{ date_end }}
  {% endif %}
{% endblock %}

{% block content %}

<div class="row">
  <div class="col-lg-8">
      <h2>Sales</h2>

      <div id="reportrange" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 100%">
          <i class="fa fa-calendar"></i>&nbsp;
          <span></span> <i class="fa fa-caret-down"></i>
      </div>

      <p><b>Sous-total</b> {{ workorder_stats.subtotal | format_currency }}</p>
      <p><b>Total</b> {{ workorder_stats.total | format_currency }}</p>
      <p><b>{{tax1_name}} </b> {{ workorder_stats.taxes1 | format_currency }}</p>
      <p><b>{{tax2_name}} </b>{{ workorder_stats.taxes2 | format_currency }}</p>
      <p><b>All taxes</b> {{ workorder_stats.taxes | format_currency }}</p>
      <p><b>Discounts</b> {{ workorder_stats.total_discounts | format_currency }}</p>
  </div>


  <script type="text/javascript">
      document.addEventListener('DOMContentLoaded', function() {
          let ranges = {
              // Hong kong style, +100 years
              'Last year': [moment().subtract(1, 'years'), moment()],
              'Last 7 Days': [moment().subtract(6, 'days'), moment()],
              'Last 30 Days': [moment().subtract(29, 'days'), moment()],
              'This Month': [moment().startOf('month'), moment().endOf('month')],
              'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
              'All time': [moment().subtract(100, 'years'), moment().add(100, 'years')],
          };

          let start = moment("{{ date_start }}");
          let end = moment("{{ date_end }}");

          let label = start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY');

          for(let predef_label in ranges) {
              console.log(predef_label)
              console.log(start.diff(ranges[predef_label][0], 'days'));
              console.log(end.diff(ranges[predef_label][1], 'days'));

              if(start.diff(ranges[predef_label][0], 'days') == 0 &&
                 end.diff(ranges[predef_label][1], 'days') == 0) {
                  label = predef_label;
                  break;
              }
          }

          $('#reportrange span').text(label);

          function submit(start, end) {
              window.location = '?date_start=' + start.format('YYYY-MM-DD') + '&date_end=' + end.format('YYYY-MM-DD');
          }

          $('#reportrange').daterangepicker({
              startDate: start,
              endDate: end,
              ranges: ranges
          }, submit);
      });
  </script>


  <div class="col-lg-4">
      <h2>Customers distribution</h2>

      <canvas id="postal-codes-piechart" width="400" height="300"></canvas>
  </div>

  <script>
      const ctx = document.getElementById('postal-codes-piechart').getContext('2d');

      const DATA_COUNT = {{ postal_codes_keys | length }};

      const colors = Array(DATA_COUNT).fill(0).map((val, i) => {
          return 'hsl(' + i / DATA_COUNT * 360 + ', 70%, 50%)';
      });

      const data = {
          labels: {{ postal_codes_keys | tojson }},
          datasets: [
              {
                  data: {{ postal_codes_vals | tojson }},
                  backgroundColor: colors,
              }
          ]
      };

      const config = {
          type: 'pie',
          data: data,
          options: {
              responsive: true,
              plugins: {
                  legend: {
                      position: 'top',
                  },
                  title: {
                      display: true,
                      text: 'Postal codes'
                  }
              }
          },
      };

      const myChart = new Chart(ctx, config);
  </script>

{% endblock %}
